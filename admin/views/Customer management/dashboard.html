<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Types</title>
    <style>
        #mainBody {
            /* border: 1px solid black; */
            display: flex;
        }

        #productTypes {
            width: 25%;
            display: block;
        }

        body {
            margin: 20px;
        }

        .list-item {
            cursor: pointer;
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        .category-item {
            cursor: pointer;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
            /* Updated style */
            margin-bottom: 5px;
        }

        .category-name {
            margin-bottom: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .sub-category-list {
            cursor: pointer;
            margin-left: 20px;
            /* Adjusted margin */
            background-color: #f8f8f8;
            border-radius: 3px;
            display: none;
            padding: 5px;
        }

        .sub-category-list-item {
            cursor: pointer;
            margin-left: 20px;
            /* Adjusted margin */
            background-color: #f8f8f8;
            border-radius: 3px;
            padding: 5px;
        }

        #products {
            /* margin-left: 30px; */
            border-radius: 3px;
            border: 1px solid red;
            height: fit-content;
            width: 50%;

        }

        #listProducts {
            margin: 10px;
            border: 1px solid red;
            height: max-content;
        }

        .product-div {
            margin: 10px;
            /* padding: auto; */
            background-color: #f8f8f8;
        }

        .img-container {
            width: 100px
        }

        .img {
            width: 300px;
        }
    </style>
</head>

<body>
    <div id="mainBody">
        <div id="productTypes"></div>
        <div id="products">

            <div id="listProducts"></div>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

    // sub-category-list-item
    async function listProducts(subCatId, subCategoryListItem) {
        let subCategoryId = subCatId
        const listProductsDiv = document.getElementById('listProducts')
        listProductsDiv.innerHTML=''

        if (subCategoryListItem) {
            subCategoryListItem.addEventListener('click', () => {
                url.searchParams.set("subCategoryId", subCatId);
                // url.searchParams.delete('param2');
                window.history.replaceState(null, null, url);
            })
        }
        const apiUrl = new URL(`http://localhost:3000/listProducts/:id`)



        const url = new URL(window.location.href);
        let prodTypeId = url.searchParams.get('prodTypeId')
        let categoryId = url.searchParams.get('categoryId')
        // console.log(prodTypeId)

        if (prodTypeId) {
            prodTypeId = apiUrl.searchParams.set('prodTypeId', prodTypeId)
        }
        if (categoryId) {
            categoryId = apiUrl.searchParams.set('categoryId', categoryId)

        }
        if (Number.isInteger(parseInt(subCategoryId))) {
            subCategoryId = apiUrl.searchParams.set('subCategoryId', subCategoryId)
        }


        const listProducts = await axios.get(apiUrl);
        const productsDiv = document.createElement('div')
        productsDiv.className = 'products-div'




        console.log('listProducts', listProducts)



        listProducts.data.data.forEach(prods => {

            const productDiv = document.createElement('div')
            productDiv.className = 'product-div'

            const imgElement = document.createElement('img')
            imgElement.className = 'img'
            const imgContainer = document.createElement('div')
            imgContainer.className = 'img-container'
            imgContainer.appendChild(imgElement)

            const productTitle = document.createElement('h3')
            productTitle.className = 'product-title'

            const productSubTitle = document.createElement('h5')
            productSubTitle.className = 'product-sub-title'

            const productShortDescription = document.createElement('p')
            productShortDescription.className = 'product-short-description-title'

            const productCost = document.createElement('p')
            productCost.className = 'product-cost'



            productTitle.innerText = prods.prodName

            productSubTitle.innerText = prods.prodSubTitle

            productShortDescription.innerText = prods.prodShortDescription

            productCost.innerText = `${prods.cost} per ${prods.quantity} - ${prods.quantityType}`

            imgElement.src = 'http://localhost:3000' + prods.imageUrl
            productDiv.appendChild(productTitle)
            productDiv.appendChild(productSubTitle)
            productDiv.appendChild(productShortDescription)

            productDiv.appendChild(imgContainer)
            productDiv.appendChild(productCost)
            productsDiv.appendChild(productDiv)



        })


        listProductsDiv.appendChild(productsDiv)




    }



    async function createProductTypeItem(productType, container) {
        const productTypeItem = createListItem(productType);
        const categoryList = document.createElement('div');

        productTypeItem.addEventListener('click', async () => {
            toggleDisplay(categoryList);
            if (categoryList.style.display === 'block') {
                const url = new URL(window.location.href);
                url.searchParams.set("prodTypeId", productType.prodTypeId);
                // url.searchParams.delete('param2');
                window.history.replaceState(null, null, url);
                fetchAndDisplayCategories(productType.prodTypeId, categoryList);
            }
        });

        container.appendChild(productTypeItem);
        container.appendChild(categoryList);
    }

    function createListItem(data) {
        const listItem = document.createElement('div');
        listItem.className = 'list-item';
        listItem.textContent = `${data.prodTypeName} ( ${data.totalProducts} )`;
        return listItem;
    }

    async function fetchAndDisplayCategories(prodTypeId, categoryList) {
        try {
            const categories = await fetchData(`http://localhost:3000/listCategory/:id?prodTypeId=${prodTypeId}`);
            renderCategories(categories, categoryList);
        } catch (error) {
            console.error(error);
        }
    }

    function renderCategories(categories, categoryList) {
        categoryList.innerHTML = '';

        categories.forEach(category => {
            const categoryItem = createCategoryItem(category);
            categoryList.appendChild(categoryItem);
        });
    }

    async function fetchAndDisplaySubCategories(categoryId, subCategoryList) {
        try {
            const subCategories = await fetchData(`http://localhost:3000/listSubCategory/:id?categoryId=${categoryId}`);
            renderSubCategories(subCategories, subCategoryList);
        } catch (error) {
            console.error(error);
        }
    }

    function renderSubCategories(subCategories, subCategoryList) {
        subCategoryList.innerHTML = '';

        subCategories.forEach(subCategory => {
            const subCategoryItem = createSubCategoryItem(subCategory);
            subCategoryList.appendChild(subCategoryItem);
        });
    }

    function createCategoryItem(category) {
        const categoryItem = document.createElement('div');
        categoryItem.className = 'category-item';

        const categoryName = document.createElement('div');
        categoryName.className = 'category-name';
        categoryName.textContent = `${category.categoryName} ( ${category.totalProducts} )`;
        categoryItem.appendChild(categoryName);

        const subCategoryList = document.createElement('div');
        subCategoryList.className = 'sub-category-list'; // Updated class name
        categoryItem.appendChild(subCategoryList);

        categoryName.addEventListener('click', () => {
            toggleDisplay(subCategoryList);
            if (subCategoryList.style.display === 'block') {
                const url = new URL(window.location.href);
                url.searchParams.set("categoryId", category.categoryId);
                // url.searchParams.delete('param2');
                window.history.replaceState(null, null, url);
                fetchAndDisplaySubCategories(category.categoryId, subCategoryList);
            }
        });

        return categoryItem;
    }

    function createSubCategoryItem(subCategory) {
        const subCategoryItem = document.createElement('div');
        subCategoryItem.className = 'sub-category-list-item';




        subCategoryItem.textContent = `${subCategory.subCategoryName}  ( ${subCategory.totalProducts} )`;
        listProducts(subCategory.subCategoryId, subCategoryItem)

        return subCategoryItem;
    }

    async function fetchData(url) {
        const response = await axios.get(url);
        return response.data.data;
    }

    function toggleDisplay(element) {
        element.style.display = element.style.display === 'block' ? 'none' : 'block';
    }

    async function fetchProductTypes() {
        try {
            const productTypes = await fetchData('http://localhost:3000/listProductType/:id');
            const productTypesContainer = document.getElementById('productTypes');

            productTypesContainer.innerHTML = '';

            productTypes.forEach(productType => {
                const productTypeDiv = document.createElement('div');
                createProductTypeItem(productType, productTypeDiv);
                productTypesContainer.appendChild(productTypeDiv);
            });
        } catch (error) {
            console.error(error);
        }
    }

    document.addEventListener('DOMContentLoaded', fetchProductTypes);
    document.addEventListener('DOMContentLoaded', listProducts);

</script>

</html>